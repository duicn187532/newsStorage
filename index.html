<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸Šæµ·å•†éŠ€TimeLine</title>
<link rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">
<script src="https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js"></script>
<style>
/* ========= å…¨å±€ UI ========= */
body {
  margin: 0;
  font-family: 'Microsoft JhengHei', sans-serif;
  background: #f5f5f5;
  color: #2D3748;
}

/* Header */
.header {
  background: #FF8C42;
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
.header h1 { font-size: 1.8em; margin: 0; }
.stats { display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9em; }

/* Toolbar */
.toolbar {
  background: #fff;
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  border-bottom: 2px solid #FF8C42;
}
.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 22px;
  background: #FF8C42;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
  margin: 2px;
}
.btn:hover { background: #FFB366; }

/* Timeline container */
.timeline-container { height: calc(100vh - 160px); overflow: auto; }

/* Timeline è¦†è“‹æ¨£å¼ */
.tl-text, .tl-text p, .tl-full-image-background .tl-text, .tl-full-color-background .tl-text, .tl-full-image-background .tl-text p, .tl-full-color-background .tl-text p {
  color: #2D3748 !important;
  text-shadow: none !important;
}
.tl-timeline { background: #FFF8F0 !important; }
.tl-timemarker { background: #FFF8F0 !important; }
.tl-timenav { background: rgba(255,248,240,0.95) !important; border-top: 2px solid #FF8C42 !important; }
.tl-timenav-line { background: #FFB366 !important; }
.tl-timenav-marker .tl-timenav-marker-content-container { background: #FF8C42 !important; border: 2px solid white !important; }

/* Timeline å¡ç‰‡ */
.timeline-card {
  background: #FFF8F0;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  color: #2D3748;
}
.timeline-card .sentiment-label {
  font-weight: 600;
  color: #fff;
  padding: 6px 14px;
  border-radius: 16px;
  font-size: 0.9em;
}
.timeline-card .category-label {
  font-weight: 500;
  color: #fff;
  padding: 6px 14px;
  border-radius: 16px;
  font-size: 0.85em;
  background: #FFB366;
}
.timeline-card .content {
  padding: 15px;
  background: #FFF3E0;
  border-radius: 8px;
  border-left: 4px solid;
  margin-bottom: 15px;
  font-size: 1em;
  color: #2D3748;
  line-height: 1.7;
}
.timeline-card .info {
  background: #FFF8F0;
  padding: 12px;
  border-radius: 8px;
  font-size: 0.9em;
  color: #555;
  line-height: 1.5;
}
.timeline-card .keywords span {
  background:#FFE0B2; 
  color:#FF8C42; 
  padding:4px 10px; 
  border-radius:12px; 
  font-size:0.85em; 
  margin-right:6px; 
  margin-bottom:6px; 
  display:inline-block;
}

/* Loading / Error */
.loading { text-align: center; padding: 40px; color: #555; }

/* ========= RWD ========= */
@media (max-width: 1024px) {
  .header { flex-direction: column; gap: 10px; text-align: center; }
  .toolbar { flex-direction: column; gap: 8px; }
  .timeline-container { height: calc(100vh - 180px); }
  .timeline-card { padding: 16px; }
}
@media (max-width: 768px) {
  .btn { padding: 5px 10px; font-size: 0.85em; }
  .timeline-card .content { font-size: 0.95em; }
  .timeline-card .info { font-size: 0.85em; }
}
@media (max-width: 480px) {
  .timeline-card { padding: 12px; margin-bottom: 15px; }
  .timeline-card .content { font-size: 0.9em; }
  .timeline-card .info { font-size: 0.8em; }
}
</style>
</head>
<body>
<div class="header">
  <h1>ä¸Šæµ·å•†éŠ€TimeLine</h1>
  <div class="stats" id="stats" style="display: none;">
    <span>ç¸½è¨ˆ <strong id="totalCount">0</strong> ç¯‡æ–°è</span>
    <span>å¹³å‡æƒ…æ„Ÿ <strong id="avgSentiment">0</strong></span>
    <span>ç¬¬ <strong id="currentPage">1</strong> é  / å…± <strong id="totalPages">1</strong> é </span>
  </div>
</div>

<div class="toolbar">
  <div class="page-controls" id="pageControls" style="display: none;">
    <button class="btn" onclick="prevPage()" id="prevBtn" disabled>ä¸Šä¸€é </button>
    <span id="pageInfo">ç¬¬ 1 é </span>
    <button class="btn" onclick="nextPage()" id="nextBtn" disabled>ä¸‹ä¸€é </button>
    <select class="btn" onchange="changePageSize()" id="pageSize">
      <option value="50" selected>æ¯é  50 ç­†</option>
      <option value="100">æ¯é  100 ç­†</option>
      <option value="200">æ¯é  200 ç­†</option>
    </select>
  </div>
</div>

<div class="timeline-container">
  <div id="timeline-embed">
    <div class="loading">
      <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“Š</div>
      <h3>æ–°èæƒ…æ„Ÿæ™‚é–“è»¸</h3>
      <p>æ­£åœ¨è¼‰å…¥æ–°èè³‡æ–™...</p>
    </div>
  </div>
</div>

<script>
let timeline, originalData = null, currentPage = 1, pageSize = 50, totalPages = 1;
const timelineOptions = { initial_zoom: 2, start_at_end: false, timenav_height: 120, language: 'zh-tw' };

document.addEventListener('DOMContentLoaded', async () => {
  const dataUrl = 'timeline_data.json';
  showLoading('æ­£åœ¨è¼‰å…¥æ–°èè³‡æ–™...');
  try {
    const res = await fetch(dataUrl);
    if (!res.ok) throw new Error('ç„¡æ³•å–å¾— JSON æª”æ¡ˆ');
    const json = await res.json();
    if (!json.events || !Array.isArray(json.events)) throw new Error('JSON æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦åŒ…å« events é™£åˆ—');
    originalData = preprocessData(json.events);
    totalPages = Math.ceil(originalData.length / pageSize);
    updateUI();
    await loadPage(1);
  } catch (err) { showError('è®€å–è³‡æ–™å¤±æ•—: ' + err.message); }
});

function preprocessData(events) {
  return events.map((event, i) => {
    const startDate = event.start_date;
    const date = new Date(startDate.year, (startDate.month || 1) - 1, startDate.day || 1);
    const textContent = event.text.text || '';
    let titleSentiment = 0, contentSentiment = 0;
    const sentimentMatch = textContent.match(/æ¨™é¡Œæƒ…æ„Ÿ:<\/b>\s*([-\d.]+)\s*\|\s*<b>å…§æ–‡æƒ…æ„Ÿ:<\/b>\s*([-\d.]+)/);
    if (sentimentMatch) { titleSentiment = parseFloat(sentimentMatch[1]); contentSentiment = parseFloat(sentimentMatch[2]); }
    const categoryMatch = textContent.match(/<b>åˆ†é¡:<\/b>\s*([^<]+)/);
    const keywordsMatch = textContent.match(/<b>é—œéµè©:<\/b>\s*([^<]+)/);
    const content = textContent.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    return { ...event, date, content, title_sentiment: titleSentiment, content_sentiment: contentSentiment,
      sentiment: contentSentiment !== 0 ? contentSentiment : titleSentiment,
      category: categoryMatch ? categoryMatch[1].trim() : '',
      keywords: keywordsMatch ? keywordsMatch[1].trim() : '', index: i
    };
  }).sort((a,b)=>a.date-b.date);
}

async function loadPage(page) {
  showLoading(`è¼‰å…¥ç¬¬ ${page} é ...`);
  const start = (page-1)*pageSize;
  const end = Math.min(start+pageSize, originalData.length);
  const pageData = originalData.slice(start,end);
  const timelineData = convertToTimeline(pageData);
  document.getElementById('timeline-embed').innerHTML = '';
  timeline = new TL.Timeline('timeline-embed', timelineData, timelineOptions);
  currentPage = page; updatePageControls();
}

function convertToTimeline(data) {
  const events = data.map(item => {
    const color = item.sentiment>0.3 ? '#4CAF50':item.sentiment<-0.3?'#F44336':'#FF9800';
    return { start_date:item.start_date, text:{ headline:item.text.headline, text:createContent(item) }, background:{ color } };
  });
  return { title:{ text:{ headline:"ğŸ“° ä¸Šæµ·å•†éŠ€TimeLine"} }, events };
}

function createContent(item) {
  const sentiment = item.sentiment||0;
  const sentimentColor = sentiment>0.3?'#4CAF50':sentiment<-0.3?'#F44336':'#FF9800';
  const sentimentText = sentiment>0.3?'æ­£é¢':sentiment<-0.3?'è² é¢':'ä¸­æ€§';
  return `<div class="timeline-card">
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
      <span class="sentiment-label" style="background:${sentimentColor}">${sentimentText} ${sentiment.toFixed(2)}</span>
      ${item.category?`<span class="category-label">${item.category}</span>`:''}
    </div>
    <div class="content" style="border-left-color:${sentimentColor}">${item.content}</div>
    <div class="info">
      <div><strong>ç™¼å¸ƒæ—¥æœŸï¼š</strong>${item.date.toLocaleDateString('zh-TW')}</div>
      <div><strong>æƒ…æ„Ÿåˆ†æï¼š</strong> æ¨™é¡Œ ${item.title_sentiment.toFixed(2)} | å…§æ–‡ ${item.content_sentiment.toFixed(2)}</div>
      ${item.keywords?`<div class="keywords">${item.keywords.split(/[;,]/).map(k=>`<span>${k.trim()}</span>`).join('')}</div>`:''}
    </div>
  </div>`;
}

function updateUI() {
  const stats = document.getElementById('stats');
  const total = originalData.length;
  const avg = (originalData.reduce((sum,item)=>sum+item.sentiment,0)/total).toFixed(2);
  document.getElementById('totalCount').textContent = total;
  document.getElementById('avgSentiment').textContent = avg;
  stats.style.display='flex';
  if(total>pageSize) document.getElementById('pageControls').style.display='flex';
}

function updatePageControls() {
  document.getElementById('currentPage').textContent=currentPage;
  document.getElementById('totalPages').textContent=totalPages;
  document.getElementById('pageInfo').textContent=`ç¬¬ ${currentPage} é `;
  document.getElementById('prevBtn').disabled=currentPage<=1;
  document.getElementById('nextBtn').disabled=currentPage>=totalPages;
}

function goToStart(){ if(timeline?.goTo) timeline.goTo(0); }
async function prevPage(){ if(currentPage>1) await loadPage(currentPage-1); }
async function nextPage(){ if(currentPage<totalPages) await loadPage(currentPage+1); }
async function changePageSize(){ pageSize=parseInt(document.getElementById('pageSize').value); if(originalData){totalPages=Math.ceil(originalData.length/pageSize); await loadPage(1);} }
function toggleFullscreen(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
function showLoading(msg){ document.getElementById('timeline-embed').innerHTML=`<div class="loading"><div class="spinner"></div><p style="font-size: 1.1em; font-weight: 500;">${msg}</p></div>`; }
function showError(msg){ document.getElementById('timeline-embed').innerHTML=`<div class="loading"><div style="font-size: 3em; color: #F44336; margin-bottom: 15px;">âŒ</div><p style="color: #F44336; font-weight: 600; font-size: 1.1em;">${msg}</p><p style="color: #666; margin-top: 10px;">è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼å¾Œé‡æ–°è¼‰å…¥</p></div>`; }

let resizeTimer;
window.addEventListener('resize',()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=>{ if(timeline?.updateDisplay) timeline.updateDisplay(); },250); });
</script>
</body>
</html>
