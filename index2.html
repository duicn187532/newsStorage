<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸Šæµ·å•†éŠ€åª’é«”è³‡æ–™åº«</title>
<style>
* { box-sizing: border-box; }
body { 
  font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; 
  margin: 0; padding: 5px; background-color: #fff8f0; color: #333;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  overflow: hidden;
}
.header {
  background: linear-gradient(135deg, #ffa500 0%, #ff7f50 100%);
  color: white;
  padding: 30px;
  text-align: center;
}
.header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
.filters {
  background: #fccb80;
  padding: 8px;
  color: white;
}
.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 4px;
}
.filter-select, .search-input {
  padding: 6px;
  border-radius: 6px;
  border: none;
}
.btn {
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
.btn-primary { background: #ff9900; color: white; }
.btn-primary:hover { background: #ff8800; transform: translateY(-1px); }
.btn-secondary { background: #ffb84d; color: white; }
.btn-secondary:hover { background: #ffaa33; transform: translateY(-1px); }
.toggle-filters {
  display: none;
  background: #ff9900;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
}
/* RWD: çª„è¢å¹•æ™‚æ”¶èµ· filter-content */
@media screen and (max-width: 768px) {
  .filter-content { display: none; flex-direction: column; gap: 8px; }
  .toggle-filters { display: block; }
  .filter-row { flex-direction: column; align-items: stretch; }
  .search-container { min-width: auto; }
  .header h1 { font-size: 2em; }
  table { font-size: 12px; }
  th, td { padding: 8px 6px; }
}
.results-info { padding: 15px 25px; background: #fff0d9; border-left: 4px solid #ff9900; margin: 0; font-weight: 500; }
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th { background: #fff2e6; padding: 15px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ffd699; cursor: pointer; position: sticky; top: 0; z-index: 10; }
th:hover { background: #ffe6cc; }
th.sortable:after { content: ' â†•'; opacity: 0.5; }
th.sort-asc:after { content: ' â†‘'; opacity: 1; }
th.sort-desc:after { content: ' â†“'; opacity: 1; }
td { padding: 12px; border-bottom: 1px solid #ffe0b3; vertical-align: top; }
tr:hover { background-color: #fff2e6; }
.title-cell { font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; }
.sentiment-positive { color: #ff6600; font-weight: 500; }
.sentiment-negative { color: #cc3300; font-weight: 500; }
.sentiment-neutral { color: #996633; font-weight: 500; }
.topic-tag { background: #ff9900; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; display: inline-block; margin: 2px; }
.stats { margin: 25px; padding: 20px; background: #fff4e6; border-radius: 8px; }
.stats h3 { margin-top: 0; color: #994d00; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
.reporter-card { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9900; }
.reporter-name { font-weight: 600; margin-bottom: 8px; }
.reporter-stats { font-size: 13px; color: #6c757d; }
.no-data, .loading { text-align: center; padding: 40px; color: #996633; font-size: 16px; }
.tab-buttons button { margin-right: 8px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ“° ä¸Šæµ·å•†éŠ€åª’é«”è³‡æ–™åº«</h1>
    <p>æ™ºæ…§æœå°‹èˆ‡åˆ†æå¹³å°</p>
  </div>

  <div class="filters">
    <button class="toggle-filters" onclick="toggleFilters()">â˜° ç¯©é¸å·¥å…·</button>
    <div class="filter-content">
      <div class="filter-row">
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹æ¨™é¡Œã€å…§æ–‡ã€é—œéµå­—...">
        </div>
        <select id="topicFilter" class="filter-select"><option value="">å…¨éƒ¨ä¸»é¡Œ</option></select>
        <select id="mediaFilter" class="filter-select"><option value="">å…¨éƒ¨åª’é«”</option></select>
        <select id="reporterFilter" class="filter-select"><option value="">å…¨éƒ¨è¨˜è€…</option></select>
      </div>
      <div class="filter-row">
        <button onclick="applyFilters()" class="btn btn-primary">ğŸ” æœå°‹</button>
        <button onclick="clearFilters()" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤</button>
        <button onclick="exportData()" class="btn btn-secondary">ğŸ“Š åŒ¯å‡º</button>
      </div>
    </div>
  </div>

  <div class="tab-buttons">
    <button class="btn btn-primary" onclick="showTab('list')">ğŸ“° æ–°èåˆ—è¡¨</button>
    <button class="btn btn-secondary" onclick="showTab('stats')">ğŸ“Š è¨˜è€…çµ±è¨ˆ</button>
  </div>

  <div id="listTab">
    <div id="resultsInfo" class="results-info"></div>
    <div class="table-container">
      <table id="newsTable">
        <thead>
          <tr>
            <th class="sortable" onclick="sortTable('date')">æ—¥æœŸ</th>
            <th class="sortable" onclick="sortTable('title')">æ¨™é¡Œ</th>
            <th class="sortable" onclick="sortTable('reporter')">è¨˜è€…</th>
            <th class="sortable" onclick="sortTable('media')">åª’é«”</th>
            <th class="sortable" onclick="sortTable('title_sentiment')">æ¨™é¡Œæƒ…æ„Ÿ</th>
            <th class="sortable" onclick="sortTable('content_sentiment')">å…§æ–‡æƒ…æ„Ÿ</th>
            <th class="sortable" onclick="sortTable('topic')">ä¸»é¡Œ</th>
            <th class="sortable" onclick="sortTable('keywords')">é—œéµå­—</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="statsTab" style="display:none;">
    <div class="stats" id="reporterStats"></div>
  </div>
</div>

<script>
let newsData = [];
let filteredData = [];
let currentSort = { field: 'date', direction: 'desc' };

document.addEventListener('DOMContentLoaded', function() {
  showLoading();
  setupEventListeners();
  loadNews(); // è‡ªå‹•è®€å– news.json
});

function setupEventListeners() {
  document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
  ['topicFilter','mediaFilter','reporterFilter'].forEach(id => {
    document.getElementById(id).addEventListener('change', applyFilters);
  });
}

async function loadNews() {
  try {
    const res = await fetch('news.json');
    newsData = await res.json();
    populateFilters();
    applyFilters();
  } catch (err) {
    alert('ç„¡æ³•è®€å– news.jsonï¼Œè«‹ç¢ºèªæª”æ¡ˆä½ç½®æ­£ç¢º');
    console.error(err);
  }
}

function populateFilters() {
  const topics = [...new Set(newsData.map(n => n.topic))].sort();
  const medias = [...new Set(newsData.map(n => n.media))].sort();
  const reporters = [...new Set(newsData.map(n => n.reporter))].sort();
  populateSelect('topicFilter', topics);
  populateSelect('mediaFilter', medias);
  populateSelect('reporterFilter', reporters);
}

function populateSelect(selectId, options) {
  const select = document.getElementById(selectId);
  const currentValue = select.value;
  select.innerHTML = select.children[0].outerHTML;
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    select.appendChild(option);
  });
  select.value = currentValue;
}

function applyFilters() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const topic = document.getElementById('topicFilter').value;
  const media = document.getElementById('mediaFilter').value;
  const reporter = document.getElementById('reporterFilter').value;

  filteredData = newsData.filter(n => {
    const matchesSearch = !search || n.title.toLowerCase().includes(search) || n.content.toLowerCase().includes(search) || (n.keywords && n.keywords.toLowerCase().includes(search));
    const matchesTopic = !topic || n.topic === topic;
    const matchesMedia = !media || n.media === media;
    const matchesReporter = !reporter || n.reporter === reporter;
    return matchesSearch && matchesTopic && matchesMedia && matchesReporter;
  });

  sortFiltered(currentSort.field, currentSort.direction);
  renderTable();
  renderStats();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  ['topicFilter','mediaFilter','reporterFilter'].forEach(id => document.getElementById(id).value = '');
  applyFilters();
}

function renderTable() {
  const tbody = document.querySelector('#newsTable tbody');
  tbody.innerHTML = '';
  if (!filteredData.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="no-data">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
    document.getElementById('resultsInfo').textContent = '';
    return;
  }
  filteredData.forEach(n => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${n.date}</td>
      <td class="title-cell" title="${n.title}">${n.title}</td>
      <td>${n.reporter}</td>
      <td>${n.media}</td>
      <td class="${sentimentClass(n.title_sentiment)}">${n.title_sentiment}</td>
      <td class="${sentimentClass(n.content_sentiment)}">${n.content_sentiment}</td>
      <td><span class="topic-tag">${n.topic}</span></td>
      <td>${n.keywords ? n.keywords.split(';').slice(0,5).map(k=>`<span class="topic-tag">${k.trim()}</span>`).join(' ') : ''}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('resultsInfo').textContent = `å…± ${filteredData.length} ç­†çµæœ`;
}

function sentimentClass(value) {
  if (value > 0) return 'sentiment-positive';
  if (value < 0) return 'sentiment-negative';
  return 'sentiment-neutral';
}

function sortTable(field) {
  let direction = 'asc';
  if (currentSort.field === field && currentSort.direction === 'asc') direction = 'desc';
  currentSort = { field, direction };
  sortFiltered(field, direction);
  renderTable();
}

function sortFiltered(field,direction) {
  filteredData.sort((a,b)=>{
    let valA=a[field], valB=b[field];
    if(field==='date'){ valA=new Date(valA); valB=new Date(valB);}
    if(valA<valB) return direction==='asc'?-1:1;
    if(valA>valB) return direction==='asc'?1:-1;
    return 0;
  });
}

function renderStats() {
  const statsEl = document.getElementById('reporterStats');
  const reporters = {};
  filteredData.forEach(n=>{
    if(!reporters[n.reporter]) reporters[n.reporter]={ count:0, titleSentiments:[], contentSentiments:[] };
    reporters[n.reporter].count++;
    reporters[n.reporter].titleSentiments.push(parseFloat(n.title_sentiment));
    reporters[n.reporter].contentSentiments.push(parseFloat(n.content_sentiment));
  });
  let html='<h3>è¨˜è€…çµ±è¨ˆ</h3><div class="stats-grid">';
  Object.entries(reporters).forEach(([r,data])=>{
    const titleAvg=(data.titleSentiments.reduce((a,b)=>a+b,0)/data.titleSentiments.length).toFixed(2);
    const titleMax=Math.max(...data.titleSentiments).toFixed(2);
    const titleMin=Math.min(...data.titleSentiments).toFixed(2);
    const contentAvg=(data.contentSentiments.reduce((a,b)=>a+b,0)/data.contentSentiments.length).toFixed(2);
    const contentMax=Math.max(...data.contentSentiments).toFixed(2);
    const contentMin=Math.min(...data.contentSentiments).toFixed(2);
    html+=`<div class="reporter-card">
      <div class="reporter-name">${r}</div>
      <div class="reporter-stats">
        å ±å°æ•¸ï¼š${data.count}<br>
        æ¨™é¡Œæƒ…æ„Ÿ â†’ å¹³å‡: ${titleAvg}, æœ€å¤§: ${titleMax}, æœ€å°: ${titleMin}<br>
        å…§æ–‡æƒ…æ„Ÿ â†’ å¹³å‡: ${contentAvg}, æœ€å¤§: ${contentMax}, æœ€å°: ${contentMin}
      </div>
    </div>`;
  });
  html+='</div>';
  statsEl.innerHTML=html;
}

function showTab(tab) {
  document.getElementById('listTab').style.display = (tab==='list')?'block':'none';
  document.getElementById('statsTab').style.display = (tab==='stats')?'block':'none';
}

function toggleFilters() {
  const fc = document.querySelector('.filter-content');
  fc.style.display = (fc.style.display==='flex')?'none':'flex';
}

function showLoading() {
  document.querySelector('#newsTable tbody').innerHTML = '<tr><td colspan="8" class="loading">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>';
}

// åŒ¯å‡º CSV
function exportData() {
  if(!filteredData.length){ alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º'); return; }
  const header = ['æ—¥æœŸ','æ¨™é¡Œ','è¨˜è€…','åª’é«”','æ¨™é¡Œæƒ…æ„Ÿ','å…§æ–‡æƒ…æ„Ÿ','ä¸»é¡Œ','é—œéµå­—'];
  const rows = filteredData.map(n=>[n.date,n.title,n.reporter,n.media,n.title_sentiment,n.content_sentiment,n.topic,n.keywords||'']);
  let csvContent = [header,...rows].map(e=>e.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='news_export.csv';
  link.click();
}

// é˜²æŠ–
function debounce(fn, delay){ let timer; return function(){ clearTimeout(timer); timer=setTimeout(()=>fn.apply(this,arguments),delay); }; }
</script>

</body>
</html>
